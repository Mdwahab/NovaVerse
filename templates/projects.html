{% extends "layout.html" %}

{% block title %}Projects{% endblock %}

{% block content %}
<section class="section">
    <div class="section-header">
        <h2>Projects</h2>
        <p>A collection of experiments, tools, and ideas brought to life.</p>
    </div>

    <div class="projects-header-row">
        <p class="projects-note">
            These projects are stored dynamically in a SQLite database.
        </p>
        <a href="#" onclick='handleAddProject(event, "{{ url_for("add_project") }}")' class="btn small">
            + Add Project
        </a>
    </div>

    {% if projects %}
    <div class="projects-grid">
        {% for project in projects %}
        <article class="project-card">
            <h3>{{ project['title'] }}</h3>
            {% if images[project['id']] %}
            <div class="project-gallery">
                {% for img in images[project['id']] %}
                <img src="{{ url_for('static', filename='images/projects/' + img) }}" class="gallery-img"
                    onclick="openModal(this.src, [{% for i in images[project['id']] %}'{{ url_for('static', filename='images/projects/' + i) }}',{% endfor %}])">
                {% endfor %}
            </div>
            {% endif %}

            <p>{{ project['description'] }}</p>

            {% if project['tags'] %}
            <ul class="pill-list">
                {% for tag in project['tags'].split(',') %}
                <li>{{ tag.strip() }}</li>
                {% endfor %}
            </ul>
            {% endif %}

            <div class="project-actions">

                {% if project['link'] %}
                <a href="{{ project['link'] }}" class="btn small ghost" target="_blank" rel="noopener noreferrer">
                    project View â†—
                </a>
                {% endif %}

                <form action="{{ url_for('delete_project', id=project['id']) }}" method="post">
                    <button class="btn small danger" type="button"
                        onclick='handleDeleteProject(event, this.form)'>Delete</button>
                </form>

            </div>
        </article>
        {% endfor %}
    </div>
    {% else %}
    <p class="empty-state">
        No projects added yet. Use the "Add Project" button to create your first one.
    </p>
    {% endif %}
</section>


<script>
    function handleAddProject(event, url) {
        event.preventDefault();
        const password = prompt("Enter Admin Password to Add Project:");
        if (!password) return;

        verifyAndProceed(password, () => {
            window.location.href = url;
        });
    }

    function handleDeleteProject(event, form) {
        event.preventDefault();

        if (!confirm('Are you sure you want to delete this project?')) return;

        const password = prompt("Enter Admin Password to Delete Project:");
        if (!password) return;

        verifyAndProceed(password, () => {
            form.submit();
        });
    }

    function verifyAndProceed(password, callback) {
        fetch("/verify-admin", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ password: password })
        })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    callback();
                } else {
                    alert("Incorrect Password! Access Denied.");
                }
            })
            .catch(err => {
                console.error(err);
                alert("Error verifying password.");
            });
    }
</script>
{% endblock %}